rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ----------------------------------------
    // POSTS
    // ----------------------------------------
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null 
                     && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null 
                            && request.auth.uid == resource.data.userId;
    }

    // ----------------------------------------
    // USER PROFILES
    // ----------------------------------------
    match /users/{userId} {
      allow read: if true;
      allow update, delete, write: if request.auth != null 
                                   && request.auth.uid == userId;
    }

    match /users {
      allow read: if true;
    }

    // ----------------------------------------
    // INVITES
    // ----------------------------------------
    match /invites/{inviteId} {
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "social-admin";
    }

    // ----------------------------------------
    // HIKES (Stored under usersByName/{username}/hikes/{hikeId})
    // Make ALL hikes PUBLIC READ
    // ----------------------------------------

    // Parent-level LIST rule for collectionGroup queries
    match /usersByName/{username}/hikes {
      allow list: if true;    // Allow public listing of hikes
    }

    // Allow listing/reading public hikes anywhere there's a "hikes" subcollection
    match /{anyPath=**}/hikes/{hikeId} {
      // LIST: required for collectionGroup queries â€” allow for anyone
      allow list: if true;

      // GET (single doc): allow if doc.public == true OR owner
      allow get: if resource.data.public == true
                || (request.auth != null && resource.data.ownerUid == request.auth.uid);
      
      // Do NOT allow create/update/delete here (keep writes restricted below)
      allow create, update, delete: if false;
    }
    
    // Document-level rules
    match /usersByName/{username}/hikes/{hikeId} {

      // CREATE: authenticated user + ownerUid matches
      allow create: if request.auth != null
                    && request.resource.data.ownerUid == request.auth.uid;

      // UPDATE / DELETE: owner only
      allow update, delete: if request.auth != null
                            && resource.data.ownerUid == request.auth.uid;

      // GET: allow public read OR owner read
      allow get: if resource.data.public == true
                 || (request.auth != null 
                     && resource.data.ownerUid == request.auth.uid);

      // LIST is handled by the parent rule above
    }
  }
}
