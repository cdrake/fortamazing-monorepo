rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    /*
     * Hike-related files:
     *   hikes/{uid}/{hikeId}/combined.json
     *   hikes/{uid}/{hikeId}/days/{dayId}.json
     *   hikes/{uid}/{hikeId}/images/{filename}
     */
    match /hikes/{uid}/{hikeId}/{allPaths=**} {

      // WRITE:
      // - must be authenticated
      // - uid in path must match auth.uid
      allow write: if request.auth != null
                   && request.auth.uid == uid;

      // READ:
      // - allow public files (metadata.public == "true")
      // - OR allow owner to read
      allow read: if (resource != null
                      && resource.metadata.public == "true")
                  || (request.auth != null
                      && request.auth.uid == uid);
    }

    // Default deny everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
